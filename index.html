<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Experiencia AR Corvaglia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar-nft.min.js"></script>
    
    <script>
        // --- COMPONENTE #1: GESTOR DE LA INTERFAZ DE USUARIO (UI) ---
        AFRAME.registerComponent('ui-manager', {
            init: function () {
                const sceneEl = this.el; // La escena <a-scene>
                const loadingScreen = document.querySelector('#loading-screen');
                const startButton = document.querySelector('#start-button');
                const infoPanel = document.querySelector('#info-panel');

                // Lógica para el botón de inicio
                startButton.addEventListener('click', () => {
                    // Pedimos permiso para la cámara
                    navigator.mediaDevices.getUserMedia({ video: true })
                        .then(() => {
                            // Si el usuario da permiso, ocultamos la pantalla de carga
                            loadingScreen.setAttribute('visible', 'false');
                            infoPanel.setAttribute('visible', 'true');
                            
                            // Activamos la escena AR. Esto es crucial.
                            sceneEl.emit('start-experience');
                        })
                        .catch(error => {
                            console.error("Error al acceder a la cámara:", error);
                            // Podríamos mostrar el error en la propia UI de AR
                            const errorText = document.querySelector('#loading-text');
                            errorText.setAttribute('value', 'Se necesita acceso a la camara para continuar.');
                        });
                });
            }
        });

        // --- COMPONENTE #2: GESTOR DEL VIDEO SOBRE EL MARCADOR ---
        AFRAME.registerComponent('video-handler', {
            init: function () {
                this.el.setAttribute('visible', false); // Ocultamos el video al inicio
                
                const marker = this.el.parentElement; // El marcador es el padre del video
                const videoAsset = document.querySelector('#video-asset');
                const infoPanel = document.querySelector('#info-panel');

                marker.addEventListener('markerFound', () => {
                    this.el.setAttribute('visible', true);
                    if (videoAsset) videoAsset.play();
                    if (infoPanel) infoPanel.setAttribute('text', { value: '¡Marcador detectado!' });
                });

                marker.addEventListener('markerLost', () => {
                    this.el.setAttribute('visible', false);
                    if (videoAsset) videoAsset.pause();
                    if (infoPanel) infoPanel.setAttribute('text', { value: 'Apunta la camara hacia la imagen' });
                });
            }
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden;">
    <a-scene
        ui-manager
        vr-mode-ui="enabled: false;"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
        renderer="antialias: true; colorManagement: true; alpha: true; logarithmicDepthBuffer: true;"
    >
        <a-assets>
            <video id="video-asset" src="/pagecorvagliaAI/assets/videos/video1.mp4" playsinline webkit-playsinline muted loop crossorigin="anonymous"></video>
        </a-assets>

        <a-marker type="nft" url="/pagecorvagliaAI/assets/nft/corvaglia">
            <a-video src="#video-asset" width="1.6" height="0.9" position="0 0.5 0" rotation="-90 0 0" video-handler></a-video>
        </a-marker>

        <a-entity camera>
            <a-entity id="loading-screen" position="0 0 -1">
                <a-plane color="#121212" height="2" width="2"></a-plane>
                <a-text id="loading-text" value="Experiencia AR Corvaglia" color="white" position="0 0.2 0" align="center" width="1.5"></a-text>
                <a-text value="Por favor, permite el acceso a la camara" color="white" position="0 0.05 0" align="center" width="1.5"></a-text>
                <a-plane id="start-button" color="#007AFF" height="0.2" width="0.8" position="0 -0.3 0" clickable>
                    <a-text value="INICIAR EXPERIENCIA" color="white" align="center"></a-text>
                </a-plane>
            </a-entity>

            <a-entity id="info-panel" position="0 -0.6 -1" visible="false">
                <a-plane color="black" opacity="0.7" height="0.15" width="1.2" rounded="0.075"></a-plane>
                <a-text value="Apunta la camara hacia la imagen" color="white" align="center" width="1.1"></a-text>
            </a-entity>
        </a-entity>
    </a-scene>
</body>
</html>
